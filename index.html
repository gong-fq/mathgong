<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦æ ¸å¿ƒç´ å…»AI - å®Œç¾è¡Œåˆ—å¼ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                macros: {
                    ddet: ["\\begin{vmatrix} #1 \\end{vmatrix}", 1],
                    ppmat: ["\\begin{pmatrix} #1 \\end{pmatrix}", 1]
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f5f7fa; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .container { 
            display: flex; 
            flex-direction: row; 
            flex: 1; 
            width: 100%;
            height: 100vh;
            padding: 15px; 
            gap: 20px; 
            overflow: hidden; 
        }

        .left-panel { 
            flex: 0 0 280px; 
            background: linear-gradient(135deg, #1a2980, #26d0ce); 
            border-radius: 20px; 
            padding: 25px; 
            color: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .right-panel { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: white; 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
        }

        .chat-container { flex: 1; padding: 25px; overflow-y: auto; background-color: #fafbfd; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 85%; padding: 15px 20px; border-radius: 18px; line-height: 1.7; word-wrap: break-word; position: relative; }
        .ai-message { align-self: flex-start; background: white; border: 1px solid #e1f0ff; }
        .user-message { align-self: flex-end; background: linear-gradient(135deg, #1a2980, #26d0ce); color: white; }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: none;
            transition: background 0.2s;
        }
        .message:hover .delete-btn { display: block; }
        .delete-btn:hover { background: rgba(255, 0, 0, 0.9); }

        .mjx-container { margin: 1.2em 0 !important; font-size: 1.1em !important; display: block !important; text-align: center; max-width: 100%; overflow-x: auto; }

        /* æ€è€ƒä¸­åŠ¨ç”» */
        .thinking {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 16px;
            color: #1a2980;
        }
        
        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            animation: thinking-bounce 1.4s infinite ease-in-out;
        }
        
        .thinking-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes thinking-bounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        #desmos-container { height: 320px; border-top: 1px solid #eee; display: none; }
        .tool-bar { padding: 10px 20px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .tool-btn { font-size: 12px; padding: 6px 15px; border-radius: 20px; border: 1px solid #1a2980; color: #1a2980; cursor: pointer; background: white; transition: all 0.2s; }
        .tool-btn:hover { background: #1a2980; color: white; }
        .tool-btn.danger { border-color: #dc3545; color: #dc3545; }
        .tool-btn.danger:hover { background: #dc3545; color: white; }

        .input-area { padding: 20px; border-top: 1px solid #eee; }
        .input-container { display: flex; gap: 12px; align-items: flex-end; }
        .input-box { flex: 1; border: 1px solid #ddd; border-radius: 12px; padding: 12px; font-size: 15px; resize: none; min-height: 50px; max-height: 150px; }
        .send-btn { background: #1a2980; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; flex-shrink: 0; transition: opacity 0.2s; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .history-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .history-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .history-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover { background: rgba(255, 255, 255, 0.2); }
        .history-item-delete {
            color: rgba(255, 100, 100, 0.8);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .history-item-delete:hover {
            background: rgba(255, 100, 100, 0.3);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h1 style="font-size: 20px; margin-bottom: 8px;">æ•°å­¦æ ¸å¿ƒç´ å…»AI</h1>
            <p style="font-size: 12px; opacity: 0.8;">é¾šå‡¤ä¹¾æ•™æˆè®¾è®¡</p>
            <hr style="margin: 15px 0; opacity: 0.2;">
            
            <div style="font-size: 13px; line-height: 1.6;">
                <p style="font-weight: bold; margin-bottom: 12px;"><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜:</p>
                <ul style="padding-left: 18px; opacity: 0.9;">
                    <li style="margin-bottom: 12px;"><strong>æ™ºèƒ½é—®ç­”:</strong>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†æè¿°æ•°å­¦é—®é¢˜,æ”¯æŒä»£æ•°ã€å‡ ä½•åŠçº¿ä»£ã€‚</li>
                    <li style="margin-bottom: 12px;"><strong>å®Œç¾å…¬å¼:</strong>æ·±åº¦ä¼˜åŒ–æ¸²æŸ“,ç²¾å‡†å±•ç¤ºå…‹è±å§†æ³•åˆ™ç­‰å¤æ‚è¡Œåˆ—å¼ã€‚</li>
                    <li style="margin-bottom: 12px;"><strong>åŠ¨æ€ç»˜å›¾:</strong>AIè‡ªåŠ¨è¯†åˆ«å‡½æ•°å¹¶è°ƒç”¨Desmoså¯è§†åŒ–ã€‚</li>
                    <li style="margin-bottom: 12px;"><strong>å†å²è®°å½•:</strong>æŸ¥çœ‹å’Œç®¡ç†èŠå¤©å†å²,æ”¯æŒåˆ é™¤åŠŸèƒ½ã€‚</li>
                </ul>
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 11px;">
                    <strong>âš ï¸ ä½¿ç”¨æç¤º:</strong><br>
                    å¦‚å‡ºç°"Failed to fetch"é”™è¯¯,è¯·:<br>
                    1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ<br>
                    2. ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸<br>
                    3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è¯¦ç»†ä¿¡æ¯
                </div>
            </div>

            <div class="history-section">
                <div class="history-title">
                    <span><i class="fas fa-history"></i> èŠå¤©å†å²</span>
                    <span style="font-size: 11px; cursor: pointer; opacity: 0.7;" id="clearAllHistory" title="æ¸…ç©ºæ‰€æœ‰å†å²">
                        <i class="fas fa-trash"></i>
                    </span>
                </div>
                <div class="history-list" id="historyList"></div>
            </div>
            
            <div style="margin-top: auto;">
                <hr style="margin: 15px 0; opacity: 0.2;">
                <p style="font-size: 12px; opacity: 0.7;">æç¤º:è‹¥é‡åˆ°æ˜¾ç¤ºå¼‚å¸¸,è¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</p>
            </div>
        </div>

        <div class="right-panel">
            <div class="chat-container" id="chatContainer">
                <div class="message ai-message">æ‚¨å¥½!æˆ‘æ˜¯æ•°å­¦åŠ©å­¦AIã€‚æˆ‘å·²ç»æ›´æ–°äº†å·¦ä¾§å¸ƒå±€å¹¶ä¼˜åŒ–äº†å“åº”é€»è¾‘ã€‚è¯·é—®æœ‰ä»€ä¹ˆæ•°å­¦é—®é¢˜æˆ‘å¯ä»¥å¸®æ‚¨?</div>
            </div>

            <div id="desmos-container"></div>
            <div class="tool-bar">
                <button class="tool-btn" id="toggleDesmos"><i class="fas fa-chart-line"></i> å¼€å¯/å…³é—­ Desmos å›¾å½¢</button>
                <button class="tool-btn danger" id="clearChat"><i class="fas fa-trash-alt"></i> æ¸…ç©ºå½“å‰å¯¹è¯</button>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <textarea class="input-box" id="messageInput" placeholder="è¯·è¾“å…¥æ•°å­¦é—®é¢˜..."></textarea>
                    <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

<script>
    // é…ç½® - ä½¿ç”¨ Netlify Serverless Functionï¼ˆAPIå¯†é’¥å·²å®‰å…¨å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼‰
    const API_URL = '/.netlify/functions/chat-stream';

    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const desmosEl = document.getElementById('desmos-container');
    const historyList = document.getElementById('historyList');

    let calculator = null;
    let chatHistory = [{ 
        role: "system", 
        content: `ä½ æ˜¯ä¸€ä¸ªæ•°å­¦æ•™è‚²ä¸“å®¶ã€‚è¦æ±‚:
1. çŸ©é˜µç”¨ pmatrix,è¡Œåˆ—å¼ç”¨ vmatrixã€‚
2. å±•ç¤ºåˆ†å¼åµŒå¥—è¡Œåˆ—å¼æ—¶å¿…é¡»å®Œæ•´ã€‚
3. å˜é‡åŒ…è£¹åœ¨ $ ä¸­ã€‚
4. å¤æ‚å…¬å¼ä½¿ç”¨ $$ã€‚
5. **é‡è¦**ï¼šå½“å›ç­”æ¶‰åŠä»»ä½•å‡½æ•°æˆ–å…¬å¼æ—¶ï¼ˆåŒ…æ‹¬æ¦‚ç‡å¯†åº¦å‡½æ•°ã€åˆ†å¸ƒå‡½æ•°ã€ç‰©ç†å…¬å¼ç­‰ï¼‰ï¼Œå¿…é¡»åœ¨å›ç­”æœ«å°¾æ·»åŠ  [GRAPH: å‡½æ•°è¡¨è¾¾å¼] æ ‡è®°ã€‚
6. å‡½æ•°è¡¨è¾¾å¼è¦æ±‚ï¼šä½¿ç”¨ç®€å•ç›´æ¥çš„Desmoså…¼å®¹æ ¼å¼ï¼š
   - çº¿æ€§: [GRAPH: y = 2x + 1]
   - äºŒæ¬¡: [GRAPH: y = x^2]
   - ä¸‰è§’: [GRAPH: y = sin(x)]
   - æŒ‡æ•°: [GRAPH: y = e^x]
   - é«˜æ–¯: [GRAPH: y = (1/(sqrt(2*pi)))*e^(-x^2/2)]
   - å¤šä¸ªå‡½æ•°ç”¨åˆ†å·åˆ†éš”: [GRAPH: y = sin(x); y = cos(x)]
7. ä¸è¦ä½¿ç”¨å¤æ‚çš„LaTeXæ ¼å¼ï¼Œä½¿ç”¨ç®€å•çš„æ•°å­¦è¡¨è¾¾å¼ã€‚
8. å³ä½¿ç”¨æˆ·åªæ˜¯è¯¢é—®å‡½æ•°åç§°ï¼ˆå¦‚"æ­£æ€åˆ†å¸ƒ"ã€"çŠ¶æ€å¯†åº¦å‡½æ•°"ï¼‰ï¼Œä¹Ÿè¦ç»™å‡ºå®Œæ•´å…¬å¼å¹¶æ·»åŠ å›¾å½¢æ ‡è®°ã€‚` 
    }];
    let conversations = []; // å­˜å‚¨æ‰€æœ‰å¯¹è¯å†å²
    let messageCounter = 0; // æ¶ˆæ¯è®¡æ•°å™¨

    // æ£€æŸ¥Desmos APIæ˜¯å¦åŠ è½½æˆåŠŸ
    function checkDesmosAPI() {
        if (typeof Desmos === 'undefined') {
            console.error('âŒ Desmos APIæœªåŠ è½½ï¼è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥');
            return false;
        }
        console.log('âœ… Desmos APIå·²åŠ è½½');
        return true;
    }

    // ä»localStorageåŠ è½½å†å²è®°å½•
    function loadHistory() {
        const saved = localStorage.getItem('chatConversations');
        if (saved) {
            conversations = JSON.parse(saved);
            updateHistoryUI();
        }
    }

    // ä¿å­˜å†å²è®°å½•åˆ°localStorage
    function saveHistory() {
        localStorage.setItem('chatConversations', JSON.stringify(conversations));
    }

    // æ›´æ–°å†å²è®°å½•UI
    function updateHistoryUI() {
        historyList.innerHTML = '';
        conversations.forEach((conv, index) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <span style="flex: 1;" title="${conv.preview}">${conv.title}</span>
                <span class="history-item-delete" data-index="${index}">Ã—</span>
            `;
            div.querySelector('span:first-child').onclick = () => loadConversation(index);
            div.querySelector('.history-item-delete').onclick = (e) => {
                e.stopPropagation();
                deleteConversation(index);
            };
            historyList.appendChild(div);
        });
    }

    // ä¿å­˜å½“å‰å¯¹è¯
    function saveCurrentConversation(userMsg, aiMsg) {
        const conv = {
            title: userMsg.substring(0, 20) + (userMsg.length > 20 ? '...' : ''),
            preview: userMsg,
            timestamp: Date.now(),
            messages: [...chatHistory]
        };
        conversations.unshift(conv);
        if (conversations.length > 20) conversations.pop(); // æœ€å¤šä¿å­˜20æ¡
        saveHistory();
        updateHistoryUI();
    }

    // åŠ è½½å†å²å¯¹è¯
    function loadConversation(index) {
        if (confirm('åŠ è½½æ­¤å¯¹è¯å°†æ¸…ç©ºå½“å‰å†…å®¹,æ˜¯å¦ç»§ç»­?')) {
            const conv = conversations[index];
            chatHistory = [...conv.messages];
            chatContainer.innerHTML = '';
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯(è·³è¿‡systemæ¶ˆæ¯)
            chatHistory.forEach((msg, idx) => {
                if (msg.role === 'user') {
                    addMessageToUI('user', msg.content, false);
                } else if (msg.role === 'assistant') {
                    addMessageToUI('ai', msg.content, false);
                }
            });
        }
    }

    // åˆ é™¤å•æ¡å†å²è®°å½•
    function deleteConversation(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—?')) {
            conversations.splice(index, 1);
            saveHistory();
            updateHistoryUI();
        }
    }

    // æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
    document.getElementById('clearAllHistory').onclick = () => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—?æ­¤æ“ä½œä¸å¯æ¢å¤!')) {
            conversations = [];
            saveHistory();
            updateHistoryUI();
        }
    };

    // æ¸…ç©ºå½“å‰å¯¹è¯
    document.getElementById('clearChat').onclick = () => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—?')) {
            chatHistory = [chatHistory[0]]; // ä¿ç•™systemæ¶ˆæ¯
            chatContainer.innerHTML = '<div class="message ai-message">å¯¹è¯å·²æ¸…ç©ºã€‚è¯·é—®æœ‰ä»€ä¹ˆæ•°å­¦é—®é¢˜æˆ‘å¯ä»¥å¸®æ‚¨?</div>';
        }
    };

    // å›¾å½¢å¼€å…³
    document.getElementById('toggleDesmos').onclick = () => {
        const show = desmosEl.style.display === 'none' || desmosEl.style.display === '';
        desmosEl.style.display = show ? 'block' : 'none';
        
        if (show) {
            setTimeout(() => {
                initializeDesmos();
                // ç»˜åˆ¶ä¸€ä¸ªæµ‹è¯•å‡½æ•°
                drawTestFunction();
            }, 100);
        }
    };

    // åˆå§‹åŒ–Desmosè®¡ç®—å™¨
    function initializeDesmos() {
        if (!checkDesmosAPI()) return;
        
        if (!calculator) {
            console.log('ğŸ”„ åˆå§‹åŒ–Desmosè®¡ç®—å™¨');
            calculator = Desmos.GraphingCalculator(desmosEl, { 
                expressions: true,
                settingsMenu: false,
                zoomButtons: true,
                expressionsCollapsed: true,
                xAxisLabel: 'x',
                yAxisLabel: 'y',
                xAxisStep: 1,
                yAxisStep: 1
            });
            console.log('âœ… Desmosè®¡ç®—å™¨åˆå§‹åŒ–æˆåŠŸ');
        }
        return calculator;
    }

    // ç»˜åˆ¶æµ‹è¯•å‡½æ•°ï¼ˆç”¨äºéªŒè¯Desmosæ˜¯å¦å·¥ä½œï¼‰
    function drawTestFunction() {
        if (!calculator) {
            calculator = initializeDesmos();
        }
        
        if (calculator) {
            try {
                calculator.setExpressions([
                    {
                        id: 'test_function',
                        latex: 'y = x^2',
                        color: Desmos.Colors.BLUE,
                        lineStyle: Desmos.Styles.SOLID,
                        lineWidth: 2
                    }
                ]);
                
                calculator.setMathBounds({
                    left: -5,
                    right: 5,
                    bottom: -2,
                    top: 10
                });
                
                console.log('âœ… æµ‹è¯•å‡½æ•°ç»˜åˆ¶æˆåŠŸ: y = x^2');
            } catch (error) {
                console.error('âŒ ç»˜åˆ¶æµ‹è¯•å‡½æ•°å¤±è´¥:', error);
            }
        }
    }

    // ç®€åŒ–ç‰ˆï¼šè‡ªåŠ¨æ£€æµ‹å¹¶ç»˜åˆ¶å‡½æ•°
    function autoDrawFunction(text) {
        console.log('ğŸ” æ£€æŸ¥æ–‡æœ¬ä¸­æ˜¯å¦æœ‰GRAPHæ ‡è®°:', text);
        
        const graphMatch = text.match(/\[GRAPH:\s*(.+?)\]/);
        if (graphMatch) {
            console.log('âœ… æ‰¾åˆ°GRAPHæ ‡è®°:', graphMatch[1]);
            const exprs = graphMatch[1].trim();
            
            // ç¡®ä¿Desmoså®¹å™¨å¯è§
            if (desmosEl.style.display !== 'block') {
                desmosEl.style.display = 'block';
                setTimeout(() => {
                    if (calculator) calculator.resize();
                }, 50);
            }
            
            // ç¡®ä¿è®¡ç®—å™¨åˆå§‹åŒ–
            if (!calculator) {
                calculator = initializeDesmos();
            }
            
            if (!calculator) {
                console.error('âŒ Desmosè®¡ç®—å™¨åˆå§‹åŒ–å¤±è´¥');
                return;
            }
            
            try {
                // æ¸…ç©ºä¹‹å‰çš„è¡¨è¾¾å¼
                calculator.setExpressions([]);
                
                // æ”¯æŒå¤šä¸ªå‡½æ•°ï¼ˆç”¨åˆ†å·åˆ†éš”ï¼‰
                const expressionList = exprs.split(';').map(e => e.trim()).filter(e => e.length > 0);
                
                console.log('ğŸ“Š è§£æåˆ°çš„è¡¨è¾¾å¼:', expressionList);
                
                // ç®€å•ç›´æ¥çš„è¡¨è¾¾å¼å¤„ç†
                expressionList.forEach((expr, index) => {
                    let processedExpr = expr
                        .replace(/\*/g, '\\cdot ')          // * æ›¿æ¢ä¸º Desmos ä¹˜æ³•ç¬¦å·
                        .replace(/pi/g, '\\pi')            // pi æ›¿æ¢ä¸º \pi
                        .replace(/\^/g, '^{')              // ^ æ›¿æ¢ä¸º ^{
                        .replace(/(\d)([a-zA-Z\(])/g, '$1\\cdot $2') // æ•°å­—åè·Ÿå˜é‡æ·»åŠ ä¹˜å·
                        .replace(/([a-zA-Z\)])(\d)/g, '$1\\cdot $2'); // å˜é‡åè·Ÿæ•°å­—æ·»åŠ ä¹˜å·
                    
                    // ç¡®ä¿è¡¨è¾¾å¼ä»¥ y = å¼€å¤´ï¼ˆå¦‚æœç¼ºå¤±ï¼‰
                    if (!processedExpr.includes('=')) {
                        processedExpr = 'y = ' + processedExpr;
                    }
                    
                    console.log(`ğŸ“ å¤„ç†è¡¨è¾¾å¼ ${index + 1}: ${expr} -> ${processedExpr}`);
                    
                    // ä¸ºæ¯ä¸ªå‡½æ•°è®¾ç½®ä¸åŒçš„é¢œè‰²
                    const colors = [
                        Desmos.Colors.BLUE,
                        Desmos.Colors.GREEN,
                        Desmos.Colors.PURPLE,
                        Desmos.Colors.RED,
                        Desmos.Colors.ORANGE,
                        Desmos.Colors.BLACK
                    ];
                    
                    try {
                        calculator.setExpression({
                            id: `graph_${Date.now()}_${index}`,
                            latex: processedExpr,
                            color: colors[index % colors.length],
                            lineWidth: 2,
                            lineStyle: Desmos.Styles.SOLID
                        });
                        console.log(`âœ… æˆåŠŸç»˜åˆ¶: ${processedExpr}`);
                    } catch (exprError) {
                        console.error(`âŒ æ— æ³•ç»˜åˆ¶è¡¨è¾¾å¼ "${processedExpr}":`, exprError);
                        
                        // å°è¯•ç®€åŒ–ç‰ˆæœ¬
                        try {
                            calculator.setExpression({
                                id: `simple_${Date.now()}_${index}`,
                                latex: 'y = x',
                                color: colors[index % colors.length],
                                lineWidth: 1,
                                lineStyle: Desmos.Styles.DASHED
                            });
                        } catch (simpleError) {
                            console.error('âŒ è¿ç®€åŒ–ç‰ˆæœ¬ä¹Ÿå¤±è´¥:', simpleError);
                        }
                    }
                });
                
                // è®¾ç½®åˆé€‚çš„è§†å›¾èŒƒå›´
                calculator.setMathBounds({
                    left: -10,
                    right: 10,
                    bottom: -5,
                    top: 5
                });
                
                console.log(`âœ… å·²å°è¯•ç»˜åˆ¶ ${expressionList.length} ä¸ªå‡½æ•°`);
                
            } catch (e) {
                console.error('âŒ Desmosç»˜å›¾é”™è¯¯:', e);
                drawTestFunction(); // å›é€€åˆ°æµ‹è¯•å‡½æ•°
            }
        } else {
            console.log('âš ï¸ æœªæ‰¾åˆ°GRAPHæ ‡è®°');
        }
    }

    // æ ¼å¼åŒ–è¾“å‡º
    function formatMathText(text) {
        let formatted = text.replace(/\\\\/g, '\\\\\\\\');
        
        // ç§»é™¤GRAPHæ ‡è®°ï¼ˆåªç”¨äºè§¦å‘ç»˜å›¾ï¼Œä¸éœ€è¦æ˜¾ç¤ºï¼‰
        formatted = formatted.replace(/\[GRAPH:\s*(.+?)\]/g, '');
        
        return marked.parse(formatted);
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°UI
    function addMessageToUI(role, text, enableDelete = true) {
        const div = document.createElement('div');
        div.className = `message ${role}-message`;
        div.setAttribute('data-id', messageCounter++);
        
        if (enableDelete) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.onclick = () => deleteMessage(div);
            div.appendChild(deleteBtn);
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = role === 'ai' ? formatMathText(text) : text;
        div.appendChild(contentDiv);
        
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        if (window.MathJax && role === 'ai') {
            MathJax.typesetPromise([contentDiv]).then(() => {
                // å»¶è¿Ÿæ‰§è¡ŒDesmosç»˜å›¾ï¼Œç¡®ä¿MathJaxæ¸²æŸ“å®Œæˆ
                setTimeout(() => {
                    autoDrawFunction(text);
                }, 500);
            });
        }
        
        return div;
    }

    // åˆ é™¤å•æ¡æ¶ˆæ¯
    function deleteMessage(msgElement) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—?')) {
            msgElement.remove();
        }
    }

    // å‘é€é€»è¾‘
    async function handleSend() {
        const content = messageInput.value.trim();
        if (!content || sendBtn.disabled) return;

        addMessageToUI('user', content);
        messageInput.value = '';
        sendBtn.disabled = true;

        const aiDiv = addMessageToUI('ai', '<span class="thinking">æ€è€ƒä¸­<span class="thinking-dot"></span><span class="thinking-dot"></span><span class="thinking-dot"></span></span>');
        let fullAIResponse = "";
        chatHistory.push({ role: "user", content: content });

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                },
                body: JSON.stringify({ 
                    model: "deepseek-chat", 
                    messages: chatHistory, 
                    stream: true 
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('APIè¿”å›é”™è¯¯:', response.status, errorText);
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            aiDiv.querySelector('div').innerHTML = ""; 

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.trim().startsWith('data: ')) {
                        const dataStr = line.replace('data: ', '').trim();
                        if (dataStr === '[DONE]') continue;
                        try {
                            const data = JSON.parse(dataStr);
                            const delta = data.choices[0].delta.content || "";
                            fullAIResponse += delta;
                            aiDiv.querySelector('div').innerHTML = formatMathText(fullAIResponse);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        } catch (e) {
                            console.error('è§£ææ•°æ®å—é”™è¯¯:', e);
                        }
                    }
                }
            }
            
            if (window.MathJax) {
                MathJax.typesetPromise([aiDiv.querySelector('div')]).then(() => {
                    // å»¶è¿Ÿæ‰§è¡ŒDesmosç»˜å›¾
                    setTimeout(() => {
                        autoDrawFunction(fullAIResponse);
                    }, 300);
                });
            }
            chatHistory.push({ role: "assistant", content: fullAIResponse });
            saveCurrentConversation(content, fullAIResponse);

        } catch (error) {
            console.error('è¯·æ±‚é”™è¯¯è¯¦æƒ…:', error);
            
            chatHistory.pop();
            
            let errorMsg = "æŠ±æ­‰,è¿æ¥å‡ºç°é—®é¢˜ã€‚å¯èƒ½çš„åŸå› :\n\n";
            errorMsg += "1. APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ\n";
            errorMsg += "2. ç½‘ç»œè¿æ¥é—®é¢˜\n";
            errorMsg += "3. APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n\n";
            errorMsg += "è¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯";
            
            aiDiv.querySelector('div').innerHTML = errorMsg.replace(/\n/g, '<br>');
        } finally {
            sendBtn.disabled = false;
        }
    }

    // äº‹ä»¶ç›‘å¬
    sendBtn.onclick = handleSend;
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    window.addEventListener('load', function() {
        console.log('ğŸ“± æ•°å­¦æ ¸å¿ƒç´ å…»AIå·²åŠ è½½');
        console.log('ğŸ§® MathJaxçŠ¶æ€:', typeof MathJax !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
        console.log('ğŸ¯ DesmosçŠ¶æ€:', typeof Desmos !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
        
        // æµ‹è¯•DesmosåŠŸèƒ½
        setTimeout(() => {
            if (typeof Desmos !== 'undefined') {
                console.log('ğŸ§ª æµ‹è¯•Desmos API...');
                // åˆå§‹åŒ–å¹¶ç»˜åˆ¶æµ‹è¯•å‡½æ•°
                initializeDesmos();
                drawTestFunction();
            } else {
                console.error('âŒ Desmos APIæœªåŠ è½½ï¼è¯·æ£€æŸ¥:');
                console.error('1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                console.error('2. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ');
                console.error('3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯');
            }
        }, 1000);
    });

    // åˆå§‹åŒ–åŠ è½½å†å²è®°å½•
    loadHistory();
</script>
</body>
</html>